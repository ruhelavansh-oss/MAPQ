---
title: "Psychometric Validation"
author: "Vansh Singh Ruhela"
format:
  html:
    code-fold: true
    df-print: kable
    toc: true
    number-sections: true
    theme: cosmo
execute:
  echo: true
  warning: false
  message: false
---

# Introduction

This section details the psychometric evaluation of the **Modified Attitudes on Psychedelics Questionnaire (MAPQ)**. We employ classical test theory (CTT) and latent variable modeling to assess the instrument's reliability and construct validity.

# 1. Setup and Data Loading

```{r setup}
#| label: setup-psych

library(readxl)
library(psych)
library(psychTools)
library(ggplot2)
library(dotenv)
library(GPArotation)
library(knitr)
library(kableExtra)

# Secure Data Loading
data_path <- "data/MAPQ_TKARONTO-3.xlsx" 
mapq_data <- read_excel(data_path, sheet = "MAPQII")

# Dimensions
dim_desc <- dim(mapq_data)
print(paste("Dataset Dimensions:", dim_desc[1], "Observations,", dim_desc[2], "Items"))
```

# 2. Item Analysis

We inspect descriptive statistics to ensure data quality.

```{r descriptives}
#| label: descriptives

desc_stats <- describe(mapq_data)
kable(head(desc_stats[, c("mean", "sd", "min", "max", "skew", "kurtosis")]), 
      caption = "Descriptive Statistics (First 6 Items)") %>%
  kable_styling(bootstrap_options = "striped")
```

# 3. Reliability Analysis (Cronbach's Alpha & Omega)

We assess internal consistency using **McDonald's Omega**, which provides a more robust estimate of reliability than Cronbach's Alpha for multi-factor scales.

```{r reliability}
#| label: reliability

# Scale Keys for the 4 Latent Constructs (LC)
# LC1: Items 1-5, LC2: Items 6-10, LC3: Items 11-15, LC4: Items 16-20
keys_indices <- list(
  LC1 = 1:5,
  LC2 = 6:10,
  LC3 = 11:15,
  LC4 = 16:20
)

# Score Items
scores <- scoreItems(keys_indices, mapq_data)
print(scores, short=FALSE)

# McDonald's Omega
omega_res <- omega(mapq_data, nfactors = 4, plot = FALSE)

# Extract and Format Omega Results
omega_summary <- data.frame(
  Metric = c("Omega Total", "Omega Hierarchical", "Alpha"),
  Value = c(omega_res$omega.tot, omega_res$omega_h, omega_res$alpha)
)

kable(omega_summary, caption = "Reliability Metrics") %>%
  kable_styling(full_width = F)
```

# 4. Factor Analysis (EFA)

We perform Exploratory Factor Analysis (EFA) with 4 factors and Oblimin rotation to confirm the theoretical structure.

```{r efa}
#| label: efa-plot
#| fig.height: 8

# EFA with 4 factors
efa_fit <- fa(mapq_data, nfactors = 4, rotate = "oblimin", fm = "minres")

# Visualize
fa.diagram(efa_fit, main = "MAPQ Factor Structure")
```

# 5. Construct Correlations

The relationship between the subscales provides insight into the structural coherence of the MAPQ.

```{r correlations}
#| label: pairs-plot

raw_scores <- scores$scores
pairs.panels(raw_scores, 
             method = "pearson", 
             hist.col = "#00AFBB",
             density = TRUE,
             ellipses = TRUE,
             main = "Correlations Between MAPQ Subscales")
```